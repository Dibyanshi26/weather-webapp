"use strict";define("VSS/Msal",["require","exports","@azure/msal-browser","VSS/Core/Observable","VSS/Platform/Authentication","VSS/Platform/Context","VSS/Platform/Feature","VSS/Platform/FPS","VSS/Platform/Telemetry","VSS/Platform/Util/Cookie","VSS/Platform/Util/Storage"],(function(e,t,i,o,r,n,s,a,c,l,d){!function(e){t[e]={};const v="MsalTokenProviderService",u="MsalTokenProvider.initialize",p="MsalTokenProvider.acquireTokenPopup",h="webPlatform.tokenProvider.acquireTokenRedirect",g="webPlatform.tokenProvider.cacheWatermark";function _(e){const t=e.getService("IVssContributionService").getData("ms.vss-web.msal-config-data"),i=null==t?void 0:t.configuration;if(i){i.cache||(i.cache={cacheLocation:"localStorage",storeAuthStateInCookie:!1}),i.system||(i.system={}),i.system.loggerOptions||(i.system.loggerOptions={});const e=parseInt((0,l.getCookie)("tfs-msaljs-loglevel"));isNaN(e)||(i.system.loggerOptions.logLevel=e)}return t}t[e].getMsalConfiguration=_;const S=new class{getMsalState(e,t,i,o){if(!i){let t;try{t=_(e),this._lkgConfiguration=t}catch(e){t=this._lkgConfiguration}if(!t)return"";i=t.accessMapping}const r=this.getPageData(e);let n;return 4===(null==r?void 0:r.hostType)&&(n=r.hostName),JSON.stringify({host:n,service:(null==r?void 0:r.serviceInstanceType)||"tfs",isLegacyDomain:"VstsAccessMapping"===i||"00000029-0000-8888-8000-000000000000"==(null==r?void 0:r.serviceInstanceType)&&"PublicAccessMapping"==i,accessMapping:i,type:t,additionalProperties:o})}getPageData(e){let t;try{t=e.getService("IVssPageService").getData(),this._lkgPageData=t}catch(e){t=this._lkgPageData}return t}};function T(e,t,i,o){return S.getMsalState(e,t,i,o)}let k;t[e].getMsalState=T;class f extends n.VssService{getPublicClientApplication(e){return k||(k=new i.PublicClientApplication(e)),k}}n.Services.add("IPublicClientApplicationFactory",{serviceFactory:f});class m extends n.VssService{constructor(){super(...arguments),this._disabled=!1,this._initialized=new o.Observable,this._msalCallbackId=null,this._telemetryDisabled=!1,this._channel=void 0,this._eventCallback=e=>{var t,o;if(e.eventType==i.EventType.ACQUIRE_TOKEN_FAILURE&&e.interactionType==i.InteractionType.Silent)this._telemetryDisabled=!0;else if(e.eventType==i.EventType.ACQUIRE_TOKEN_SUCCESS){const t=e.payload;this._informServiceWorker(t.accessToken,t.expiresOn||void 0),this._telemetryDisabled=!1}if(e.eventType==i.EventType.POPUP_OPENED){this.pageContext.getService("IVssPerformanceService").addSplitTiming("popupOpened",p)}else if(e.interactionType==i.InteractionType.Popup&&(e.eventType==i.EventType.ACQUIRE_TOKEN_SUCCESS||e.eventType==i.EventType.ACQUIRE_TOKEN_FAILURE||e.eventType==i.EventType.LOGIN_FAILURE||e.eventType==i.EventType.LOGIN_SUCCESS)){this.pageContext.getService("IVssPerformanceService").addSplitTiming("popupClosed",p)}this._shouldReportEvent(e)&&this._publishEvent({eventType:e.eventType,interactionType:e.interactionType,error:null===(t=e.error)||void 0===t?void 0:t.message,msalCorrelationId:null===(o=e.payload)||void 0===o?void 0:o.correlationId})}}_serviceStart(e){super._serviceStart(e);const t=this.pageContext.getService("IVssPageService").getData();t&&(E=t.sessionId);const i=(0,d.tryGetSessionStorageObject)(h);(0,d.trySetSessionStorageObject)(h,void 0),(null==i?void 0:i.previousSessionId)&&(E=i.previousSessionId);const o=this.pageContext.getService("IVssPerformanceService"),r=b(o,u,null==i?void 0:i.startEpochMilliseconds,{location:null==i?void 0:i.location});window.self!==window.top&&(console.log("iframe detected; MSAL token provider is disabled"),this._disabled=!0),"true"==(0,l.getCookie)("tfs-aad-token-disabled")&&(console.log("MSAL token provider disabled via tfs-aad-token-disabled cookie"),this._disabled=!0);const n=this._getProvider();n?((null==i?void 0:i.startEpochMilliseconds)&&r.splitTimings.push({name:"backFromInteractive",timestamp:o.getNavigationStartTime()-r.startTime}),I(o,"MsalTokenProviderService.initializePromise.start"),o.addSplitTiming("MsalTokenProviderService.initializePromise.start",u),this._pca.initialize().then((()=>{I(o,"MsalTokenProviderService.initializePromise.end"),this._spaAuthorizationCode?(console.log("MSAL.js acquiring token with SPA authorization code"),I(o,"MsalTokenProviderService.acquireTokenByCode.start"),this._pca.acquireTokenByCode({code:this._spaAuthorizationCode,scopes:this._scopes}).then((e=>{I(o,"MsalTokenProviderService.acquireTokenByCode.end"),n.setActiveAccount(e.account),console.log("MSAL.js token provider initialization completed via acquireTokenByCode"),this._completeInitialization(),this._fpsTarget&&(0,a.FastPageSwitch)(this.pageContext,this._fpsTarget,!1)})).catch((e=>{console.log("MSAL.js acquireTokenByCode failed: "+e),this._initialize(n)}))):(I(o,"MsalTokenProviderService.handleRedirectPromise.start"),this._pca.handleRedirectPromise().then((e=>{var t,i;if(I(o,"MsalTokenProviderService.handleRedirectPromise.end"),e){if(e.state){const o=JSON.parse(e.state);if(null===(t=null==o?void 0:o.additionalProperties)||void 0===t?void 0:t.redirectHandler){console.log("MSAL.js token provider initialization completed for proof of presence"),this._completeInitialization();const t=this.pageContext.getService("IVssContributionService"),r=t.getContributionChildren("ms.vss-web.msal-redirect-callback-handlers");if(r&&r.length>0)for(const n of r){const r=t.getServiceSync(n);if((null==r?void 0:r.name)===(null===(i=null==o?void 0:o.additionalProperties)||void 0===i?void 0:i.redirectHandler)){null==r||r.invoke(e,o.additionalProperties);break}}return}}n.setActiveAccount(e.account),console.log("MSAL.js token provider initialization completed via handleRedirectPromise"),this._completeInitialization(),this._fpsTarget&&(0,a.FastPageSwitch)(this.pageContext,this._fpsTarget,!1)}else console.log("MSAL.js token provider init: no in-flight redirect promise"),this._fpsTarget&&this._signInUrl?(console.log("MSAL.js token provider init: detected full-page-load"),I(o,"MsalTokenProviderService.acquireTokenSilent.start"),n.acquireTokenSilent().then((e=>{var t;I(o,"MsalTokenProviderService.acquireTokenSilent.end"),e.interactionRequired?((0,d.trySetSessionStorageObject)(h,{startEpochMilliseconds:(null===(t=o.getActiveScenario(u))||void 0===t?void 0:t.startTime)||o.getNavigationStartTime(),previousSessionId:E,location:this._fpsTarget}),console.log("MSAL.js cookieless flow didn't get a token. redirecting to login"),n.loginRedirect()):(console.log("MSAL.js token provider initialization completed via acquireTokenSilent"),e.token&&this._informServiceWorker(e.token,e.expiresOn),this._completeInitialization(),(0,a.FastPageSwitch)(this.pageContext,this._fpsTarget,!1))})).catch((e=>{console.log("MSAL.js acquireTokenSilent failed; redirecting to sign-in. error: "+e),window.location.href=this._signInUrl}))):this._initialize(n)})).catch((e=>{console.log("MSAL.js token provider init: handling in-flight redirect promise failed: "+e),this._initialize(n)})))})).catch((e=>{I(o,"MsalTokenProviderService.initializePromise.end"),console.log("PublicClientApplication.initialize failed: "+e),this._disabled=!0,this._completeInitialization()}))):(console.log("MSAL.js token provider disabled"),I(o,"MsalTokenProviderService.disabled"),setTimeout((()=>this._completeInitialization()),0))}_initialize(e){var t;const i=this.pageContext.getService("IVssPerformanceService");let o;try{o=e.getActiveAccount()}catch(t){return console.log(t),void this._logout(e)}if(o)console.log("MSAL.js token provider init: acquireTokenSilent"),I(i,"MsalTokenProviderService.acquireTokenSilent.start"),e.acquireTokenSilent().then((t=>{var o;I(i,"MsalTokenProviderService.acquireTokenSilent.end"),t.interactionRequired?(console.log("MSAL.js token provider init: interaction required"),(0,d.trySetSessionStorageObject)(h,{startEpochMilliseconds:(null===(o=i.getActiveScenario(u))||void 0===o?void 0:o.startTime)||i.getNavigationStartTime(),location:window.location.href}),e.acquireTokenRedirect().catch((t=>{console.log("MSAL.js token provider init: acquireTokenRedirect failed with "+t),this._logout(e)}))):(t.error&&console.log(t.error),console.log("MSAL.js token provider initialization complete"),this._completeInitialization())}));else{try{const e=this.pageContext.getService("IMsalLoginProviderService");if(e&&!e.loginRequired)return console.log("MSAL.js login provider service says no login is necessary; disabling MSAL.js; initialization complete"),this._disabled=!0,void this._completeInitialization()}catch(e){console.log(e)}(0,d.trySetSessionStorageObject)(h,{startEpochMilliseconds:(null===(t=i.getActiveScenario(u))||void 0===t?void 0:t.startTime)||i.getNavigationStartTime(),previousSessionId:E,location:window.location.href}),console.log("MSAL.js token provider init: loginRedirect"),e.loginRedirect()}}_logout(e){console.log("MSAL.js token provider init: calling logoutRedirect"),this._pca.logoutRedirect({onRedirectNavigate:()=>!1}).then((()=>{e.loginRedirect()}))}get initialized(){return this._initialized}async clearCache(){if(this._pca)return await this._pca.clearCache()}async logout(){if(!this._disabled&&this._pca)try{await this._pca.logoutRedirect({onRedirectNavigate:e=>!1})}catch(e){console.log(e)}}getDefaultProvider(){return this.getPopupProvider()}getSilentProvider(){if(!this._silentTokenProvider){const e=this._getProvider();if(!e)return;this._silentTokenProvider=new y(e,(()=>this._telemetryDisabled=!1),(()=>this._telemetryDisabled=!0))}return this._silentTokenProvider}getPopupProvider(){if(!this._popupTokenProvider){const e=this._getProvider();if(!e)return;this._popupTokenProvider=new A(e)}return this._popupTokenProvider}getRedirectProvider(e){const t=this._getProvider();if(t)return new P(t,e)}_getProvider(){if(!this._disabled){if(!this._provider){if(!this.pageContext.getService("IVssContributionService").getContribution("ms.vss-web.msal-js-token-provider"))return console.log("msal-js-token-provider is not available. MSAL token provider is disabled"),void(this._disabled=!0);const e=_(this.pageContext),t=null==e?void 0:e.configuration;if(!t)return console.log("no MSAL configuration found. MSAL token provider is disabled"),void(this._disabled=!0);const o=parseInt((0,d.tryGetLocalStorageValue)(g,"0")||"0");e.cacheWatermark&&(isNaN(o)||e.cacheWatermark>o)&&(this._publishEvent({eventType:"clearCache",description:"clearing localStorage because the watermark is out of date"}),localStorage.clear(),(0,d.trySetLocalStorageValue)(g,Math.max((new Date).getTime(),e.cacheWatermark).toString())),t.system.loggerOptions.loggerCallback=(e,t,o)=>{if(!o)switch(this._recordMsalLogs(e,t),e){case i.LogLevel.Error:return void console.error(t);case i.LogLevel.Info:return void console.info(t);case i.LogLevel.Verbose:return void console.debug(t);case i.LogLevel.Warning:return void console.warn(t);case i.LogLevel.Trace:return void console.trace(t)}};const r=this.pageContext.getService("IPublicClientApplicationFactory");this._pca=r.getPublicClientApplication(t),this._provider=new C(this.pageContext,this._pca,e),this._spaAuthorizationCode=e.spaAuthorizationCode,this._fpsTarget=e.fpsTarget,this._signInUrl=e.signInUrl,this._scopes=e.scopes,this._msalCallbackId=this._pca.addEventCallback(this._eventCallback)}return this._provider}}_serviceEnd(e){this._msalCallbackId&&this._pca.removeEventCallback(this._msalCallbackId)}_informServiceWorker(e,t){var i,o;this._isServiceWorkerEnabled()&&(null===(o=null===(i=navigator.serviceWorker)||void 0===i?void 0:i.controller)||void 0===o||o.postMessage({type:"acquireTokenSuccess",version:1,token:e,expiresOn:t}))}_shouldReportEvent(e){return e.eventType==i.EventType.ACQUIRE_TOKEN_BY_CODE_SUCCESS||e.eventType==i.EventType.ACQUIRE_TOKEN_BY_CODE_FAILURE||e.eventType==i.EventType.ACQUIRE_TOKEN_FAILURE||e.eventType==i.EventType.ACQUIRE_TOKEN_NETWORK_START||e.eventType==i.EventType.LOGIN_FAILURE||e.eventType==i.EventType.LOGIN_START||e.eventType==i.EventType.LOGIN_SUCCESS||e.eventType==i.EventType.POPUP_OPENED||e.eventType==i.EventType.ACQUIRE_TOKEN_SUCCESS&&(e.interactionType==i.InteractionType.Popup||e.interactionType==i.InteractionType.Redirect)}_recordMsalLogs(e,t){e>=i.LogLevel.Info||this._publishEvent({eventType:"logging",level:e,message:t})}_completeInitialization(){const e=this.pageContext.getService("IVssPerformanceService");!this._disabled&&this._isServiceWorkerEnabled()&&this._setupBroadcastChannel(),I(e,"MsalTokenProviderService.initializationComplete"),e.endScenario(v,u,!1,void 0,{isDisabled:this._disabled}),document.dispatchEvent(new CustomEvent("authenticationInitialized",{})),this._initialized.notify(!0,"initialized",!0)}_publishEvent(e){this._telemetryDisabled||(0,c.publishEvent)(this.pageContext,"WebPlatform","MsalTokenProviderService",R(e))}_isServiceWorkerEnabled(){return(0,s.isFeatureFlagEnabled)(this.pageContext,"WebPlatform.ServiceWorker.Enabled",!1)}_setupBroadcastChannel(){try{this._channel=new BroadcastChannel("msalTokenRequest"),this._channel.onmessage=e=>{"tokenRequest"===e.data.type&&1===e.data.version&&this._provider.acquireTokenSilent()}}catch(e){console.error("msalTokenRequest channel setup failed: "+e),this._channel&&(this._channel.close(),this._channel=void 0)}}}t[e].MsalTokenProviderService=m,n.Services.add("IMsalTokenProviderService",{serviceFactory:m,options:6});class y{constructor(e,t,i){this._reportedSilentError=!1,this._provider=e,this._onSuccess=t,this._onError=i}get providerName(){return this._provider.providerName}async getAuthorizationHeader(e){var t;const o=await this._provider.acquireTokenSilent(i.CacheLookupPolicy.AccessToken);if(o.token)return this._reportedSilentError=!1,this._onSuccess&&this._onSuccess(),(0,r.getBearerTokenAuthHeaderValue)(o.token);if(o.error instanceof i.ClientAuthError){if(o.error.errorCode===i.ClientAuthErrorCodes.tokenRefreshRequired)return""}if(this._onError&&this._onError(),!this._reportedSilentError){this._reportedSilentError=!0;const e={eventType:"SilentMsalTokenProvider.error",error:null===(t=o.error)||void 0===t?void 0:t.message,interactionRequired:o.interactionRequired};o.error instanceof i.AuthError&&(e.msalCorrelationId=o.error.correlationId,e.errorCode=o.error.errorCode,e.subError=o.error.subError),this._provider.publishEvent(e)}return""}}class P{constructor(e,t){this._provider=e,this._targetLocation=t}get providerName(){return this._provider.providerName}async getAuthorizationHeader(e){if(e)try{return await this._provider.acquireTokenRedirect(this._targetLocation)}catch(e){console.log(e)}else{const e=await this._provider.acquireTokenSilent();if(e.token)return(0,r.getBearerTokenAuthHeaderValue)(e.token);if(e.interactionRequired)try{return await this._provider.acquireTokenRedirect(this._targetLocation)}catch(e){console.log(e)}}return""}}class A{constructor(e){this._provider=e}get providerName(){return this._provider.providerName}get skipFedAuthRedirectHeader(){return!0}async getAuthorizationHeader(e){let t="";if(e)t=await this._provider.acquireTokenPopup();else{const e=await this._provider.acquireTokenSilent();e.token?t=e.token:e.interactionRequired&&(t=await this._provider.acquireTokenPopup())}return t?(0,r.getBearerTokenAuthHeaderValue)(t):""}}class C{constructor(e,t,o){this._cacheLookupPolicy=o.cacheLookupPolicy||i.CacheLookupPolicy.Default,this._configuration=o,this._fatalErrorCodes=o.fatalErrorCodes||[],this._pageContext=e,this._pca=t,this._scopes=o.scopes,this._bypassPcaActiveAccount=(0,s.isFeatureFlagEnabled)(this._pageContext,"VisualStudio.WebPlatform.MsalConfig.BypassPcaActiveAccount",!1)}get providerName(){return"MsalTokenProvider"}async acquireTokenSilent(e=this._cacheLookupPolicy){const t=await this._acquireToken((async()=>{try{const t=await this._acquireTokenSilent(e);return{token:this._handleAuthenticationResult(t),expiresOn:t.expiresOn||void 0}}catch(e){return this._isFatalError(e)&&await this._handleFatalError(e),{error:e}}}));return{error:t.error,interactionRequired:this._isInteractionRequiredError(t.error),token:t.token,expiresOn:t.expiresOn}}async acquireTokenPopup(){var e;return null!==(e=(await this._acquireToken((async()=>{try{return{token:(await this._acquireTokenPopup()).accessToken}}catch(e){return{error:e}}}))).token)&&void 0!==e?e:""}async acquireTokenRedirect(e){var t;return null!==(t=(await this._acquireToken((async()=>((0,d.tryGetSessionStorageObject)(h)||(0,d.trySetSessionStorageObject)(h,{startEpochMilliseconds:(new Date).getTime(),location:e,previousSessionId:E}),await this._acquireTokenRedirect(e),{token:""})))).token)&&void 0!==t?t:""}async loginRedirect(e){await this._acquireToken((async()=>((0,d.tryGetSessionStorageObject)(h)||(0,d.trySetSessionStorageObject)(h,{startEpochMilliseconds:(new Date).getTime(),previousSessionId:E,location:window.location.href}),console.log("calling loginRedirect"),await this._pca.loginRedirect(this._getRedirectRequest(e)),{token:""})))}publishEvent(e){(0,c.publishEvent)(this._pageContext,"WebPlatform","MsalTokenProviderService",R(e))}setActiveAccount(e){this._bypassPcaActiveAccount?(0,d.trySetSessionStorageObject)(this._getActiveAccountStorageKey(),e):this._pca.setActiveAccount(e)}getActiveAccount(){var e,t;if(this._bypassPcaActiveAccount){let i=(0,d.tryGetSessionStorageObject)(this._getActiveAccountStorageKey());if(!i){const o=(null===(e=this._configuration.authenticatedUser)||void 0===e?void 0:e.tenantId)||"",r=(null===(t=this._configuration.authenticatedUser)||void 0===t?void 0:t.oid)||"",n=this._pca.getAllAccounts();o&&r&&(i=n.find(((e,t)=>e.tenantId.toLowerCase()==o&&e.localAccountId.toLowerCase()==r))),i?this.setActiveAccount(i):i=this._pca.getActiveAccount()||n[0]}return i}return this._pca.getActiveAccount()||this._pca.getAllAccounts()[0]}_getActiveAccountStorageKey(){var e,t;return"webPlatform.tokenProvider.activeAccount."+(null!==(t=null===(e=S.getPageData(this._pageContext))||void 0===e?void 0:e.hostId)&&void 0!==t?t:"")}_acquireToken(e){return this._activePromise||(this._activePromise=e()),this._activePromise.finally((()=>{delete this._activePromise})),this._activePromise}async _acquireTokenSilent(e){const t="MsalTokenProvider.acquireTokenSilent",i=Date.now(),o=await this._pca.acquireTokenSilent({account:this.getActiveAccount(),scopes:this._scopes,cacheLookupPolicy:e,state:T(this._pageContext,"popup")});if(!o.fromCache){const e=this._pageContext.getService("IVssPerformanceService");b(e,t,i),e.endScenario(v,t,!1)}return o}async _acquireTokenPopup(){const e=this._pageContext.getService("IVssNavigationService"),t=this._pageContext.getService("IVssPerformanceService");b(t,p,void 0,{currentRoute:e.getCurrentRoute().routeId});try{return await this._pca.acquireTokenPopup({account:this.getActiveAccount(),scopes:this._scopes,state:T(this._pageContext,"popup")})}finally{t.endScenario(v,p,!1)}}_acquireTokenRedirect(e){const t=this._getRedirectRequest(e);return console.log("calling acquireTokenRedirect with targetLocation "+e),this._pca.acquireTokenRedirect(t)}_getRedirectRequest(e){return{account:this.getActiveAccount(),scopes:this._scopes,state:T(this._pageContext,"redirect"),redirectStartPage:e}}_handleAuthenticationResult(e){return this.setActiveAccount(e.account),e.accessToken}_isFatalError(e){return this._fatalErrorCodes.some((t=>{var i;return null===(i=e.message)||void 0===i?void 0:i.includes(t)}))}async _handleFatalError(e){console.log(e),await this._pca.logoutRedirect({onRedirectNavigate:()=>!1}),await this._pca.loginRedirect(this._getRedirectRequest())}_isInteractionRequiredError(e){if(!e)return!1;if(e instanceof i.InteractionRequiredAuthError||e instanceof i.BrowserAuthError)return!0;if(e instanceof i.ServerError){return"invalid_grant"===e.errorCode}return!1}}let E="";function b(e,t,i,o){return e.startScenario(t,!1,i,R(o))}function I(e,t){e.addSplitTiming(t,u),e.addSplitTiming(t)}function R(e){return e||(e={}),e.msalTokenProviderSessionId=E,e}}("MsalAuthentication")}),["MsalAuthentication"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-web.msal-content"}}));