"use strict";define("TFS/Admin/Views/OrganizationPolicies",["require","exports","TFS/Admin/Common/RestClient/OrganizationPolicy","TFS/Admin/Common/RestClient/Organization","react","VSS/Core/Util/String","VSS/Platform/Layout","VSS/Core/Observable","VSSUI/Icon","VSSUI/Button","VSSUI/Link","VSSUI/Toggle","VSSUI/TooltipEx","TFS/Admin/Common/Util/Telemetry/AdminTelemetry","TFS/Admin/Common/Constants/TelemetryConstants","VSSUI/Header","VSSUI/MessageCard","VSSUI/Spinner","VSSUI/Surface","VSSUI/ZeroData","VSSUI/List","VSSUI/Observer","VSSUI/Page","VSS/Platform/Location"],(function(e,t,s,i,o,r,n,a,c,l,u,p,h,g,d,m,y,A,f,P,C,S,E,v){var w,O,b,T,M;w=t[M="Resources"]={},t[M].PoliciesPageTitle="Policies",t[M].ApplicationConnectionPolicies="Application connection policies",t[M].DirectoryPolicies="Directory policies",t[M].SecurityPolicies="Security policies",t[M].WorkItemLinkingPolicies="Workitem linking policies",t[M].UserPolicies="User policies",t[M].AriaLabelLearnMoreAbout="Learn more about the policy: {0}",t[M].On="On",t[M].Off="Off",t[M].OnAndEnforce="On (enforce for all organizations in the enterprise)",t[M].OffAndEnforce="Off (enforce for all organizations in the enterprise)",t[M].DoNotEnforce="Do not enforce for organizations in the enterprise",t[M].OnAndDoNotEnforce="On (do not enforce for all organizations in the enterprise)",t[M].OffAndDoNotEnforce="Off (do not enforce for all organizations in the enterprise)",t[M].ConfirmPolicyHeader="Change policy setting",t[M].PolicyDescription="Are you sure you want to {0} the policy '{1}' to setting '{2}'?",t[M].PolicyChangeDescription="Permanently turn off policy '{0}'?",t[M].PolicyChangeCannotUndo="You can't undo this.",t[M].Enforce="enforce",t[M].Change="change",t[M].NoLongerEnforce="no longer enforce",t[M].EnforcePolicyDetail="This change will affect the organizations where the current setting is '<b>{0}</b>'.",t[M].ChangePolicyDetailAllOrganizations="This policy will continue to be enforced across all organizations in the enterprise.",t[M].ChangePolicyDetail="This policy will continue to be enforced across this organization.",t[M].SetAnonymousAccessWarningMessage="Any projects that were previously configured as public will be shared publicly again. They will be viewable by public users.",t[M].SetAnonymousAccessOffWarningMessage="All projects that are shared publicly will become private projects. This means they will no longer be viewable by anonymous users.",t[M].SetEnterpriseVisibleWarningMessage="All projects that were previously Enterprise-visible will go back to being Enterprise visible. This means they will be viewable by all users in your Enterprise.",t[M].SetEnterpriseNonVisibleWarningMessage="All projects that are shared with your Enterprise will become private projects. This means they will no longer be viewable by all users in your Enterprise.",t[M].PolicyDescriptionEnterpiseWide="Are you sure you want to {0} the policy '{1}' to setting '{2}' across all organizations in your enterprise?",t[M].SaveButtonLabel="Save",t[M].EditUrlButtonLabel="Edit Url",t[M].RequestAccessPolicyHeader="Request Access setting",t[M].RequestAccessPolicyDescription="To turn off Request Access, provide a URL to your organization's internal process that will help your users gain access to this organization or to a project in this organization. This URL will only be visible to users belonging to the same tenant as the organization. ",t[M].SavingError='There was an error saving changes for "{0}".',t[M].ZeroData="No policies available",t[M].DisableExternalGuestAccessAsGuestError="External guest users are not allowed to disable this policy.",function(e){O=t[e]={},function(e){e.MODIFY=1,e.MODIFY_PROPERTIES=2,e.DELETE=4,e.MODIFY_COLLECTION=16,e.DELETE_COLLECTION=32}(t[e].PermissionConstants||(t[e].PermissionConstants={})),function(e){e[e.On=1]="On",e[e.Off=2]="Off"}(t[e].PolicyValue||(t[e].PolicyValue={})),function(e){e.NONE=0,e.COLLECTION=1,e.ORGANIZATION=2}(t[e].HostTypeConstants||(t[e].HostTypeConstants={})),function(e){e.NULL_AS_STRING="null",e.TRUE_AS_STRING="true"}(t[e].ComponentConstants||(t[e].ComponentConstants={})),function(e){e.DisallowOAuthAuthentication="Policy.DisallowOAuthAuthentication",e.DisallowAadGuestUserAccess="Policy.DisallowAadGuestUserAccess",e.DisallowSecureShell="Policy.DisallowSecureShell",e.EnforceAadAuthorization="Policy.EnforceAadAuthorization",e.AuthenticationCredentialValidFrom="Policy.AuthenticationCredentialValidFrom",e.IsInternal="Policy.IsInternal",e.AllowAnonymousAccess="Policy.AllowAnonymousAccess",e.AllowOrgAccess="Policy.AllowOrgAccess",e.EnforceAADConditionalAccess="Policy.EnforceAADConditionalAccess",e.IsReadOnly="Policy.IsReadOnly",e.AllowGitHubInvitations="Policy.AllowGitHubInvitationsAccessToken",e.AllowRequestAccess="Policy.AllowRequestAccessToken",e.Namespace="Policy"}(t[e].PolicyNames||(t[e].PolicyNames={})),function(e){e.VALUE_PATH="/Value",e.ENFORCE_PATH="/Enforce",e.NAME_PATH="/Name",e.IS_ACTIVATED_PATH="/IsActivated",e.TENANT_ID_PATH="/TenantId",e.REQUEST_ACCESS_URL_PATH="/SystemProperty.RequestAccessUrl"}(t[e].SourceConstants||(t[e].SourceConstants={}))}("ContractsDataModels"),function(e){b=t[e]={};t[e].OrganizationPoliciesSource=class{getPolicyTitleText(e){switch(e){case"applicationConnection":return w.ApplicationConnectionPolicies;case"directory":return w.DirectoryPolicies;case"security":return w.SecurityPolicies;case"workItemLinking":return w.WorkItemLinkingPolicies;case"user":return w.UserPolicies}return e}updatePolicy(e,t,i){return(0,s.getOrganizationPolicyClient)(e).updatePolicy((()=>{let e=[];return e.push({from:"",op:2,path:O.SourceConstants.VALUE_PATH,value:this.handleInvertedPolicies(t,i).toString()}),e})(),t.name)}updateProperties(e,t,s){return(0,i.getOrganizationClient)(e).updateCollectionProperties(s,(()=>{let e=[];return null!==t&&e.push({from:"",op:2,path:O.SourceConstants.REQUEST_ACCESS_URL_PATH,value:t}),e})())}handleInvertedPolicies(e,t){return t&&-1!=t.indexOf(e.name)?!e.effectiveValue:e.effectiveValue}}}("SourcesOrganizationPoliciesSource"),function(e){T=t[e]={};class s extends n.VssComponent{constructor(e,t){super(e,t),this.onToggleChanged=(e,t)=>{this.toggleOption.value=t,this.props.onChangeHandler(this.props.keyId,t,!1)},this.toggleOption=new a.ObservableValue(!0)}componentDidMount(){this.setDataProvider()}componentDidUpdate(){this.setDataProvider()}render(){let e=this.props.policy.policy;return o.createElement("div",{className:"policy-row-container"},o.createElement(p.Toggle,{className:"policy-toggle",offText:w.Off,offAriaLabel:w.Off,onText:w.On,onAriaLabel:w.On,checked:this.toggleOption,onChange:this.onToggleChanged,disabled:!this.props.hasPolicyPermissions||this.props.isOrganizationActivated&&e.parentPolicy&&e.parentPolicy.enforce}),o.createElement("div",{className:"policy-name-container"},o.createElement("span",null,this.props.policy.description?this.props.policy.description:e.name),0!==(0,r.localeIgnoreCaseComparer)(this.props.policy.learnMoreLink,"about:blank")&&o.createElement(h.Tooltip,{text:r.format(w.AriaLabelLearnMoreAbout,this.props.policy.description?this.props.policy.description:e.name)},o.createElement(u.Link,{ariaLabel:r.format(w.AriaLabelLearnMoreAbout,this.props.policy.description?this.props.policy.description:e.name),id:"learn-more-"+e.name,href:this.props.policy.learnMoreLink,target:" _blank",className:"policy-description-container"},o.createElement(c.Icon,{className:"icon-margin",iconName:"Link",size:"small"}))),this.props.hasUrl?o.createElement(l.Button,{primary:!1,className:"policy-editurl-button",onClick:()=>{this.props.onEditUrlClick(this.props.policy.description,this.props.policy.learnMoreLink)},disabled:this.props.policy.policy.effectiveValue},w.EditUrlButtonLabel):null))}setDataProvider(){const e=function(e,t){if(t&&e.policy.parentPolicy&&e.policy.parentPolicy.enforce)return e.policy.parentPolicy.effectiveValue.toString().trim().toLowerCase()==O.ComponentConstants.TRUE_AS_STRING?O.PolicyValue.On:O.PolicyValue.Off;if(e.policy.effectiveValue.toString().trim().toLowerCase()==O.ComponentConstants.TRUE_AS_STRING)return O.PolicyValue.On;return O.PolicyValue.Off}(this.props.policy,this.props.isOrganizationActivated);this.toggleOption.value=e===O.PolicyValue.On}}t[e].Policy=s}("Policy"),function(e){t[e]={};class s extends n.VssComponent{constructor(e,t){super(e,t),this.telemetryLogger=new g.AdminTelemetry(this.context.pageContext),this.performanceRecorded=!1,this.getPolicies=()=>{var e=this._startActionCapture("FetchFromDataProvider",{});var t=this.context.pageContext.getService("IVssContributionService").getData("ms.vss-admin-web.organization-policies-data-provider");t?(this.isGuestUser=t.isGuestUser,this.hostId=t.hostId,this.requestAccessUrl=t.requestAccessUrl,this.setState({data:t})):e.captureError("ErrorFromDataProvider")},this._startActionCapture=(e,t)=>this.telemetryLogger.startActionCapture(d.Feature.OrganizationPolicies,d.Feature.OrganizationPolicies,e,t),this.renderPolicyRow=(e,t,s,i,r)=>{var n=!1;return t.policy.name==O.PolicyNames.AllowRequestAccess&&(n=!0),o.createElement(C.ListItem,{key:"li-"+e,index:e,details:s},o.createElement(T.Policy,{key:i+e.toString(),policy:t,keyId:e.toString(),onChangeHandler:(e,t,s)=>{this.onPolicyChanged(this.state.data.policies[i][+e],i,e,t,s,this.state.data.invertedPolicies)},hasPolicyPermissions:0!=r,isOrganizationActivated:this.state.data.isOrganizationActivated,hasUrl:n,onEditUrlClick:(e,t)=>this.onEditUrlClick(e,t)}))},this.onEditUrlClick=(e,t)=>{this.requestAccessMessage={requestAccessTitle:w.RequestAccessPolicyHeader,requestAccessMessage:w.RequestAccessPolicyDescription,requestAccessLearnMoreLink:t},this.showRequestAccessDialog.value=!0},this.onPolicyChanged=(e,t,s,i,o,n)=>{var a=this._startActionCapture("PolicyChanged",{});const c=o!==!!e.policy.enforce;if(this.policyUpdateConfiguration={policy:e,section:t,key:s,value:i,enforce:o,invertedPolicies:n},e.policy.name===O.PolicyNames.AllowAnonymousAccess||e.policy.name===O.PolicyNames.AllowOrgAccess){let t;switch(e.policy.name){case O.PolicyNames.AllowAnonymousAccess:t=i?w.SetAnonymousAccessWarningMessage:w.SetAnonymousAccessOffWarningMessage;break;case O.PolicyNames.AllowOrgAccess:t=i?w.SetEnterpriseVisibleWarningMessage:w.SetEnterpriseNonVisibleWarningMessage}c||(t=w.ChangePolicyDetail+" "+t),this.dialogMessage={title:w.ConfirmPolicyHeader,confirmationMessage:r.format(w.PolicyDescription,c?o?w.Enforce:w.NoLongerEnforce:w.Change,e.description,i?w.On:w.Off),warningMessage:t},this.showConfirmationDialog.value=!0}else e.policy.name===O.PolicyNames.DisallowAadGuestUserAccess&&!i&&this.isGuestUser?(this.errorMessage=w.DisableExternalGuestAccessAsGuestError,this.setState({updateInProgress:!1,showErrorMessage:!0,data:this.state.data}),a.captureError("DisableExternalGuestAccessAsGuestError")):e.policy.name!==O.PolicyNames.AllowRequestAccess||i?(this.showConfirmationDialog.value=!1,this.policyChangeRequested(this.policyUpdateConfiguration)):(this.requestAccessMessage={requestAccessTitle:w.RequestAccessPolicyHeader,requestAccessMessage:w.RequestAccessPolicyDescription,requestAccessLearnMoreLink:e.learnMoreLink},this.showRequestAccessDialog.value=!0);a.captureTelemetry({ShowConfirmationDialog:this.showConfirmationDialog.value})},this.confirmationCancel=()=>{this.showConfirmationDialog.value=!1,this.policyUpdateConfiguration&&(this.policyUpdateConfiguration=void 0,this.forceUpdate())},this.onConfirmation=()=>{this.policyUpdateConfiguration&&this.policyChangeRequested(this.policyUpdateConfiguration)},this._onRequestAccessCancel=()=>{this.showRequestAccessDialog.value=!1,this.policyUpdateConfiguration&&(this.policyUpdateConfiguration=void 0,this.forceUpdate())},this._onRequestAccessSave=e=>{this.policyUpdateConfiguration?this.policyChangeRequestedWithProperty(this.policyUpdateConfiguration,e):null!=e&&this._urlChangeRequested(e)},this.state={showErrorMessage:!1,updateInProgress:!1,data:{}},this.errorMessage="",this._source=new b.OrganizationPoliciesSource,this.showConfirmationDialog=new a.ObservableValue(!1),this.showRequestAccessDialog=new a.ObservableValue(!1)}componentDidMount(){this.getPolicies()}render(){if(!this.performanceRecorded&&this.state.data.policies){this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(d.Area.Admin,d.Feature.OrganizationPolicies),this.performanceRecorded=!0}let e=this.state.data.permissionBits&O.PermissionConstants.MODIFY_COLLECTION,t=[];for(let s in this.state.data.policies){const i=s;t.push(o.createElement("section",{key:i,role:"region"},o.createElement(m.CustomHeader,null,o.createElement(m.HeaderTitle,{className:"text-ellipsis",titleSize:2},this._source.getPolicyTitleText(i))),o.createElement(C.List,{itemProvider:{value:this.state.data.policies[i],length:this.state.data.policies[i].length},renderRow:(t,s,o)=>this.renderPolicyRow(t,s,o,i,e)})))}return o.createElement(f.Surface,{background:1},o.createElement(E.Page,{className:"flex-grow flex-column policies-page bolt-page-white"},o.createElement(m.CustomHeader,null,o.createElement(m.HeaderTitleArea,{className:"flex-column"},o.createElement(m.HeaderTitle,{className:"text-ellipsis",titleSize:1},w.PoliciesPageTitle))),o.createElement("div",{className:"flex-column flex-grow"},this.state.showErrorMessage&&this._showActionErrorMessage(),this.state.updateInProgress?o.createElement(A.Spinner,{className:"flex-row flex-grow",size:"large"}):o.createElement(o.Fragment,null,t.length>0?t:this._showZeroDataMessage(),o.createElement(S.Observer,{showConfirmationDialog:this.showConfirmationDialog},(e=>e.showConfirmationDialog&&o.createElement(n.WrappedComponent,{dependencies:["ms.vss-admin-web.admin-common"],wrappedType:"ms.vss-admin-web.confirmation-dialog",wrappedProps:{onCancel:this.confirmationCancel,onItemConfirm:this.onConfirmation,dialogTitle:null!=this.dialogMessage?this.dialogMessage.title:"",confirmationMessage:null!=this.dialogMessage?this.dialogMessage.confirmationMessage:"",warningMessage:null!=this.dialogMessage?this.dialogMessage.warningMessage:void 0,confirmationButtonLabel:w.SaveButtonLabel,learnMoreLink:null!=this.dialogMessage?this.dialogMessage.learnMoreLink:void 0}}))),o.createElement(S.Observer,{showRequestAccessDialog:this.showRequestAccessDialog},(e=>e.showRequestAccessDialog&&o.createElement(n.WrappedComponent,{dependencies:["ms.vss-admin-web.admin-common"],wrappedType:"ms.vss-admin-web.requestaccess-dialog",wrappedProps:{onCancel:this._onRequestAccessCancel,onSave:e=>{this._onRequestAccessSave(e)},requestAccessTitle:null!=this.requestAccessMessage?this.requestAccessMessage.requestAccessTitle:"",requestAccessMessage:null!=this.requestAccessMessage?this.requestAccessMessage.requestAccessMessage:"",saveButtonLabel:w.SaveButtonLabel,requestAccessUrl:this.requestAccessUrl,requestAccessLearnMoreLink:null!=this.requestAccessMessage?this.requestAccessMessage.requestAccessLearnMoreLink:""}})))))))}policyChangeRequested(e){var t=this._startActionCapture("PolicyChangeRequested",{});this.showConfirmationDialog.value=!1,this.setState({updateInProgress:!0});var s=this.state.data;let o=i(e.policy);o.policy.effectiveValue=e.value,o.policy.enforce=e.enforce,this._source.updatePolicy(this.context.pageContext,o.policy,e.invertedPolicies).then((()=>{s.policies[e.section][+e.key]=o,this.setState({updateInProgress:!1,data:s,showErrorMessage:!1})}),(e=>{this.errorMessage=r.format(w.SavingError,e.message||String(e)),this.setState({updateInProgress:!1,showErrorMessage:!0,data:s}),t.captureError("ErrorSavingPolicy")}))}policyChangeRequestedWithProperty(e,t){var s=this._startActionCapture("PolicyChangeRequested",{});this.showRequestAccessDialog.value=!1,this.setState({updateInProgress:!0});var o=this.state.data;let n=i(e.policy);n.policy.effectiveValue=e.value,n.policy.enforce=e.enforce,this._source.updateProperties(this.context.pageContext,t,this.hostId).then((()=>{this._source.updatePolicy(this.context.pageContext,n.policy,e.invertedPolicies).then((()=>{o.policies[e.section][+e.key]=n,this.setState({updateInProgress:!1,data:o,showErrorMessage:!1}),this.requestAccessUrl=t}),(e=>{this.errorMessage=r.format(w.SavingError,e.message||String(e)),this.setState({updateInProgress:!1,showErrorMessage:!0,data:o}),s.captureError("ErrorSavingPolicy")}))}),(e=>{this.errorMessage=r.format(w.SavingError,e.message||String(e)),this.setState({updateInProgress:!1,showErrorMessage:!0,data:o}),s.captureError("ErrorSavingPolicy")}))}_urlChangeRequested(e){var t=this._startActionCapture("UrlChangeRequested",{});this.showRequestAccessDialog.value=!1,this._source.updateProperties(this.context.pageContext,e,this.hostId).then((()=>{this.requestAccessUrl=e}),(e=>{this.errorMessage=r.format(w.SavingError,e.message||String(e)),t.captureError("ErrorSavingPolicy")}))}_showActionErrorMessage(){return o.createElement(y.MessageCard,{className:"message-warning-card",severity:"Error",onDismiss:()=>this.setState({showErrorMessage:!1})},o.createElement("span",null," ",this.errorMessage))}_showZeroDataMessage(){return o.createElement(P.ZeroData,{imagePath:(0,v.getAssetLocation)(this.context.pageContext,"ms.vss-tfs-web/platform-content/Illustrations/general-no-results-found.svg"),imageAltText:w.ZeroData,primaryText:w.ZeroData})}}function i(e){return JSON.parse(JSON.stringify(e))}t[e].OrganizationPoliciesComponent=s,t[e].clone=i,n.Components.add("organizationPolicies",s)}("OrganizationPolicies")}),["Resources","Contracts/DataModels","Sources/OrganizationPoliciesSource","Policy","OrganizationPolicies"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-admin-web.admin-organization-policies-content"}}));